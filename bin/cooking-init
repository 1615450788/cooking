#!/usr/bin/env node

var path = require('path')
var PLUGIN_PATH = require('../util/path').PLUGIN_PATH
var exec = require('../util/exec')
var logger = require('../util/logger')
var program = require('commander')
var slush = require.resolve('slush/bin/slush')
var isInstalled = require('../util/is-installed')

program
  .option('-r --registry [registry-url]', '指定镜像, 默认选用 taobao 镜像')
  .parse(process.argv)

var name = 'cooking-' + (program.args[0] || 'vue')
var template = 'slush-' + name

console.log()
process.on('exit', function () {
  console.log()
})

/**
 * download template
 * @param  {string} template template name
 */
var installTemplate = function (template) {
  var registry = program.registry
  var options = [
    'install',
    template,
    '--prefix',
    PLUGIN_PATH
  ]

  if (registry) {
    var isURL = /(https?|ftp):\/\//.test(registry)

    registry = isURL ? registry : 'https://registry.npm.taobao.org'
    options.push('--registry=' + registry)
  }

  logger.log('downloading \'' + template + '\'')
  exec('npm', options, {
    stdio: 'inherit'
  })
  logger.success('template install success!')
}

/**
 * run slush
 * @param  {string} name slush template name
 */
var generator = function (name) {
  logger.log('generator project')
  exec(slush, [
      name
    ], {
    stdio: 'inherit',
    errorMessage: 'slush runtime error'
  })
}

var packageFile = path.join(template.split('@')[0], 'package.json')

if (!isInstalled(packageFile)) {
  installTemplate(template)
}

generator(name.split('@')[0])
